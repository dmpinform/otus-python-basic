{% extends "base.html" %}
{% block title %}
    <div class="m-2">
         <a href="/" class="button"><span class="badge bg-secondary">К моим рисункам </span></a>
    </div>
{% endblock %}

{% block content %}
{{object.size}}
 <div class="m-2">
      <canvas id="myCanvas"></canvas>
 </div>

<script>

     let data = JSON.parse("{{object.size}}");
     let cw = data[0];
     let ch = data[1];

     let text_x = JSON.parse("{{object.x}}");
     let text_y = JSON.parse("{{object.y}}");

     let part = {{object.size_part}};

     let state = JSON.parse("{{object.state}}");

     function getSquare(canvas, evt) {
        let rect = canvas.getBoundingClientRect();
        return {
            x: 1 + (evt.clientX - rect.left) - (evt.clientX - rect.left)%part,
            y: 1 + (evt.clientY - rect.top) - (evt.clientY - rect.top)%part
        };
    }

    function drawGrid(context) {
        canvas.width = cw*part
        canvas.height = ch*part

        for (let x = 0.5; x < cw*part + 1; x += part) {
          context.moveTo(x, 0);
          context.lineTo(x, ch*part );
        }

        for (let y = 0.5; y < ch*part + 1; y += part) {
          context.moveTo(0, y);
          context.lineTo(cw*part, y);
        }

        context.strokeStyle = "#ddd";
        context.stroke();
    }

    let canvas = document.getElementById('myCanvas');
    let context = canvas.getContext('2d');
    let csrftoken = '{{ csrf_token }}'

     function fillSquare(context, x, y){

         let cell = Math.floor(y / part) * cw + Math.floor(x / part)

         $.ajax({
                 url: '/picpart/update_state/',
                 headers:{'X-CSRFToken':csrftoken},
                 data: {'id': '{{ object.id }}', 'cell': cell},
                 type: 'POST'
               }).done(function(response){
                 //alert(response)
               });

        context.fillStyle = "black"
        context.fillRect(x,y,part-1,part-1);
    }

    drawGrid(context);

    canvas.addEventListener('click', function(evt) {
        let mousePos = getSquare(canvas, evt);
        fillSquare(context, mousePos.x, mousePos.y)
    }, false);


</script>
{% endblock %}